<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DD Inventory System</title>
  <link rel="stylesheet" href="src/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js" integrity="sha512-k/KAe4Yff9EUdYI5/IAHlwUswqeipP+Cp5qnrsUjTPCgl51La2/JhyyjNciztD7mWNKLSXci48m7cctATKfLlQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <header>
    <h1>DD Inventory System</h1>
  </header>
  <main>
    <p>Scan</p>
    <p><strong style="font-size: 1.1em; text-decoration: underline;">ITEM</strong></p>
    <div id="reader"><img src="qr.svg" alt="Scan QR code" width="180"></div>
    <div class="field">
      <input type="text" id="scanned-text" placeholder="Scanned text will appear here" readonly>
    </div>
    <div class="radio-group">
      <label><input type="radio" name="status" value="IN" onclick="toggleFields()"> IN</label>
      <label><input type="radio" name="status" value="OUT" onclick="toggleFields()"> OUT</label>
    </div>
    <div class="field order-number-field" id="order-number-field">
      <label for="order-number" class="disabled">ORDER NUMBER</label>
      <input type="number" id="order-number" min="10000" max="100000" placeholder="Enter order number" disabled>
    </div>
    <div id="order-submit-placeholder" class="disabled">
      <button class="gray-button" disabled>Submit</button>
    </div>

    <div id="second-scan-section" class="disabled">
      <p>Scan</p>
      <p><strong style="font-size: 1.1em; text-decoration: underline;">LOCATION</strong></p>
      <div id="second-reader" class="gray-placeholder"><img src="grayqr.svg" alt="Scan QR code" width="180"></div>
      <div class="field">
        <input type="text" id="second-scanned-text" placeholder="Scanned text will appear here" readonly class="gray-placeholder">
      </div>
      <button class="gray-button" disabled>Submit</button>
    </div>
  </main>
<script>
  const html5QrCode = new Html5Qrcode("reader");

  // Delegate click events to handle dynamic content
  document.addEventListener('click', function(event) {
    if (event.target.closest('#reader img')) {
      // Start QR scanning
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        onError
      ).catch(err => {
        console.error("Error starting QR code scanner: ", err);
      });
    }
  });

  function onScanSuccess(decodedText, decodedResult) {
    document.getElementById('scanned-text').value = decodedText;
    html5QrCode.stop().then(() => {
      document.getElementById('reader').innerHTML = '<img src="qr.svg" alt="Scan QR code" width="180">';
    }).catch(err => {
      console.error("Error stopping QR code scanner: ", err);
    });
  }

  function onError(err) {
    console.error("QR Code scanning error:", err);
  }

  function toggleFields() {
    const status = document.querySelector('input[name="status"]:checked').value;
    const orderNumberField = document.getElementById('order-number-field');
    const secondScanSection = document.getElementById('second-scan-section');
    const imageSrc = status === 'IN' ? 'qr.svg' : 'grayqr.svg';

    document.getElementById('second-reader').innerHTML = `<img src="${imageSrc}" alt="Scan QR code" width="180">`;

    // Disable/enable input fields and buttons based on the status
    orderNumberField.querySelector('input').disabled = status !== 'OUT';
    orderNumberField.querySelector('label').classList.toggle('disabled', status !== 'OUT');
    secondScanSection.querySelectorAll('input, button').forEach(el => el.disabled = status !== 'IN');
  }

  function handleSubmit() {
    const scannedText = document.getElementById('scanned-text').value;
    const status = document.querySelector('input[name="status"]:checked').value;

    if (!scannedText) {
      alert("Please scan an item.");
      return;
    }

    // Collect data for submission based on status
    const data = {
      itemNumber: scannedText,
      status: status
    };

    if (status === 'OUT') {
      const orderNumber = document.getElementById('order-number').value;
      if (!orderNumber || orderNumber < 10000 || orderNumber > 100000) {
        alert("Please enter a valid order number between 10000 and 100000.");
        return;
      }
      data.orderNumber = orderNumber;
    } else {
      const locationText = document.getElementById('second-scanned-text').value;
      if (!locationText) {
        alert("Please scan a location.");
        return;
      }
      data.location = locationText;
    }

    // API call to submit data
    fetch('https://script.google.com/macros/s/AKfycbwSznRJhCm2rugfE972ugVGvcomrPH-WpAJvJMrLcfVX3B9CwZF0Uz1Og0yy5T03bltrQ/exec', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    }).then(response => response.json()).then(response => {
      alert('Success: ' + response.message);
      resetForm();
    }).catch(error => {
      console.error('Error:', error);
      alert('Error: ' + error.message);
    });
  }

  function resetForm() {
    document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
    document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
    toggleFields();
  }
</script>
</body>
</html>
